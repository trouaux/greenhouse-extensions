name: Bump plugindefinition.yaml version on Chart.yaml change

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  bump-version:
    if: github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find changed Chart.yaml files
        id: chartdiff
        run: |
          git fetch origin ${{ github.base_ref }}
          files=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep 'charts/Chart.yaml$' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Bump version in plugindefinition.yaml
        if: steps.chartdiff.outputs.files != ''
        run: |
          git fetch origin ${{ github.base_ref }}
          for chart in $(git diff --name-only origin/${{ github.base_ref }} HEAD | grep 'charts/Chart.yaml$'); do
            parentdir=$(dirname "$(dirname "$chart")")
            newver=$(grep '^version:' "$chart" | awk '{print $2}')
            plugindef="$parentdir/plugindefinition.yaml"
            if [ -f "$plugindef" ]; then
              sed -i.bak "s/version: .*/version: $newver/" "$plugindef"
              rm "$plugindef.bak"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add "$plugindef"
              git commit -m "chore: bump version in $plugindef to $newver"
            fi
          done
          git push